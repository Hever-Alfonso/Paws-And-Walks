<!-- templates/chatbot/chat_interface.html -->
{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-8">
        <!-- Resumen del perfil -->
        <div class="alert alert-light border mb-4" style="background-color: #f5f1e8; border-color: #d4c0a1;">
            <strong>Conversando con:</strong>
            {{ pet_profile.name }} ({{ pet_profile.type }} â€¢ {{ pet_profile.breed }} â€¢ {{ pet_profile.age }} aÃ±os â€¢ {{ pet_profile.weight }} kg)
            <a href="{% url 'pet_assistant_reset' %}" class="ms-3" style="color: #8b5e3c; text-decoration: underline;">
            Cambiar perfil
            </a>
        </div>

        <!-- Chat -->
        <div class="card shadow-sm border-0" style="background-color: #fdf9f3;">
            <div class="card-header bg-white py-2 border-bottom" style="border-color: #e8d9c8;">
                <h5 class="mb-0" style="color: #8b5e3c;">ðŸ’¬ PregÃºntame lo que quieras sobre {{ pet_profile.name }}</h5>
            </div>
            <div id="chatbox" class="p-3" style="height: 400px; overflow-y: auto; background-color: #faf9f5;"></div>
            <div class="card-footer bg-white">
                <form id="chat-form" class="d-flex gap-2">
                    <input type="text" id="user-input" class="form-control" placeholder="Ej: Â¿CÃ³mo entrenar a {{ pet_profile.name }}?" required>
                    <button type="submit" class="btn" style="background-color: #8b5e3c; color: white; width: 80px;">Enviar</button>
                </form>
            </div>
        </div>
    </div>
</div>

<style>
    .user-bubble {
        background-color: #e8d9c8;
        color: #333;
        border-radius: 15px 15px 0 15px;
        padding: 10px 14px;
        max-width: 80%;
        margin-left: auto;
        text-align: right;
    }

    .bot-bubble {
        background-color: #d4c0a1;
        color: #333;
        border-radius: 15px 15px 15px 0;
        padding: 10px 14px;
        max-width: 80%;
        margin-right: auto;
    }

    #chatbox {
        display: flex;
        flex-direction: column;
    }

    .message-row {
        display: flex;
        margin-bottom: 12px;
    }
</style>

<script>
  document.getElementById('chat-form').addEventListener('submit', async function(e) {
    e.preventDefault();
    const input = document.getElementById('user-input');
    const msg = input.value.trim();
    if (!msg) return;

    appendMessage(msg, 'user');
    input.value = '';
    input.disabled = true;

    try {
      const res = await fetch('/chatbot/', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded',
          'X-CSRFToken': '{{ csrf_token }}'
        },
        body: 'message=' + encodeURIComponent(msg)
      });
      const data = await res.json();
      if (data.reply) {
        appendMessage(data.reply, 'bot');
      } else {
        appendMessage('Lo siento, no pude responder. Â¿PodrÃ­as reformular?', 'bot');
      }
    } catch (err) {
      appendMessage('Error de conexiÃ³n. Por favor, intÃ©ntalo de nuevo.', 'bot');
    } finally {
      input.disabled = false;
      input.focus();
    }
  });

  function appendMessage(text, sender) {
    const chatbox = document.getElementById('chatbox');
    const row = document.createElement('div');
    row.className = 'message-row';
    row.style.justifyContent = sender === 'user' ? 'flex-end' : 'flex-start';

    const bubble = document.createElement('div');
    bubble.className = sender === 'user' ? 'user-bubble' : 'bot-bubble';
    bubble.textContent = text;

    row.appendChild(bubble);
    chatbox.appendChild(row);
    chatbox.scrollTop = chatbox.scrollHeight;
  }

  // Mensaje de bienvenida
  window.onload = () => {
    appendMessage(`Â¡Hola! Soy tu asistente de mascotas. Â¿En quÃ© puedo ayudarte con {{ pet_profile.name }}?`, 'bot');
  };
</script>
{% endblock %}